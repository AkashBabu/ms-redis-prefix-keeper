stages:
  - build
  - test
  - push

image: 'docker:latest'

services:
  - 'docker:dind'

before_script:
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  
variables:
  PROJECT_NAME: ms-registry
  IMAGE_TAG: $CI_PROJECT_PATH:$CI_COMMIT_REF_NAME

build:
  stage: build
  script:
    - 'docker build -t $IMAGE_TAG .'
    - mkdir /docker-images
    - docker save -o /docker-images/$PROJECT_NAME $IMAGE_TAG
  artifacts:
    paths:
      - /docker-images
  only:
    - master
  except:
    - tags


test:
  stage: test
  variables:
    TEST_CMD: 'npm run test:docker'
  before_script:
    - docker pull mongo
    - docker network create --driver bridge mongo
    - docker run -d --name mongo --net mongo --expose 27017 --rm mongo
    - docker load < /docker-images/$PROJECT_NAME
  script:
    - 'docker run -d --net mongo --rm --name $PROJECT_NAME $IMAGE_TAG'
    - 'docker exec $PROJECT_NAME $TEST_CMD'
  only:
    - master
  except:
    - tags

push:
  stage: push

  before_script:
    - docker load < /docker-images/$PROJECT_NAME
  script:
    - docker push $IMAGE_TAG
  only:
    - master
  except:
    - tags
